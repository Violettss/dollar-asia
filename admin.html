<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - DOLARASIA Money Changer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/responsive.css" />
  </head>
  <body>
    <!-- Header Navigation -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <a href="index.html" class="logo">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/a9e17315b5788b80eb2c0ad026a6ad4759b49024"
              alt="Dolarasia Logo"
              class="logo-img"
            />
          </a>

          <nav class="nav" id="nav">
            <a href="index.html" class="nav-link">Home</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="exchange.html" class="nav-link">Exchange</a>
            <a href="history.html" class="nav-link">History</a>
            <a href="admin.html" class="nav-link active">Admin</a>
            <a href="database.html" class="nav-link">Database</a>
          </nav>

          <div class="user-menu">
            <div id="user-dropdown" class="user-dropdown">
              <button class="user-btn" id="user-btn">
                <svg
                  class="user-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span id="user-name">Admin</span>
              </button>
              <div class="dropdown-menu" id="dropdown-menu">
                <a href="dashboard.html" class="dropdown-item">Dashboard</a>
                <button class="dropdown-item" id="logout-btn">Logout</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="dashboard-container">
        <!-- Page Header -->
        <div class="dashboard-header">
          <h1 class="dashboard-title">
            <svg
              style="
                width: 2rem;
                height: 2rem;
                margin-right: 0.5rem;
                color: #3b82f6;
              "
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <circle cx="9" cy="9" r="2"></circle>
              <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
            </svg>
            Admin Panel
          </h1>
          <p class="dashboard-subtitle">
            Kelola dan verifikasi transaksi penukaran mata uang
          </p>
        </div>

        <!-- Admin Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon pending">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="admin-stat-pending">0</div>
              <div class="stat-label">Perlu Review</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon completed">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M9 12l2 2 4-4"></path>
                <circle cx="12" cy="12" r="10"></circle>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="admin-stat-completed">0</div>
              <div class="stat-label">Selesai</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon rejected">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="admin-stat-rejected">0</div>
              <div class="stat-label">Ditolak</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon total">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                ></path>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="admin-stat-total">0</div>
              <div class="stat-label">Total Transaksi</div>
            </div>
          </div>
        </div>

        <!-- Transaction Management -->
        <div class="dashboard-card">
          <div class="card-header">
            <h3 class="card-title">Manajemen Transaksi</h3>
            <div class="card-actions">
              <select id="admin-status-filter" class="filter-select">
                <option value="all">Semua Status</option>
                <option value="pending">Menunggu Review</option>
                <option value="completed">Selesai</option>
                <option value="rejected">Ditolak</option>
              </select>
              <button class="btn btn-outline btn-sm" id="refresh-btn">
                <svg
                  style="width: 1rem; height: 1rem; margin-right: 0.25rem"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="23,4 23,10 17,10"></polyline>
                  <polyline points="1,20 1,14 7,14"></polyline>
                  <path
                    d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"
                  ></path>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <div id="admin-transactions" class="loading">
            <div class="spinner"></div>
            <p>Memuat transaksi...</p>
          </div>
        </div>

        <!-- User Management -->
        <div class="dashboard-card">
          <div class="card-header">
            <h3 class="card-title">Manajemen User</h3>
          </div>

          <div class="user-stats">
            <div class="user-stat-item">
              <span class="stat-label">Total User:</span>
              <span class="stat-value" id="total-users">0</span>
            </div>
            <div class="user-stat-item">
              <span class="stat-label">User Admin:</span>
              <span class="stat-value" id="admin-users">0</span>
            </div>
            <div class="user-stat-item">
              <span class="stat-label">User Regular:</span>
              <span class="stat-value" id="regular-users">0</span>
            </div>
          </div>

          <div id="user-list" class="user-list">
            <!-- Dynamic user list -->
          </div>
        </div>
      </div>
    </main>

    <!-- Transaction Review Modal -->
    <div id="review-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Review Transaksi</h3>
          <button class="modal-close" onclick="closeReviewModal()">
            &times;
          </button>
        </div>
        <div class="modal-body" id="review-modal-content">
          <!-- Dynamic content -->
        </div>
      </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
      // Admin panel functionality
      document.addEventListener("DOMContentLoaded", function () {
        loadAdminData();
        initializeAdminFilters();
      });

      function loadAdminData() {
        loadAllTransactions();
        loadUserData();
        updateAdminStatistics();
      }

      function loadAllTransactions() {
        const transactions = window.utils.storage.get(
          "dolarasia_transactions",
          [],
        );
        const sortedTransactions = transactions.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt),
        );

        displayAdminTransactions(sortedTransactions);
        return sortedTransactions;
      }

      function updateAdminStatistics() {
        const transactions = window.utils.storage.get(
          "dolarasia_transactions",
          [],
        );

        const stats = {
          pending: transactions.filter((t) => t.status === "pending").length,
          completed: transactions.filter((t) => t.status === "completed")
            .length,
          rejected: transactions.filter((t) => t.status === "rejected").length,
          total: transactions.length,
        };

        document.getElementById("admin-stat-pending").textContent =
          stats.pending;
        document.getElementById("admin-stat-completed").textContent =
          stats.completed;
        document.getElementById("admin-stat-rejected").textContent =
          stats.rejected;
        document.getElementById("admin-stat-total").textContent = stats.total;
      }

      function displayAdminTransactions(transactions) {
        const container = document.getElementById("admin-transactions");

        if (transactions.length === 0) {
          container.innerHTML = `
            <div class="no-transactions">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; color: #ccc; margin-bottom: 1rem;">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <circle cx="9" cy="9" r="2"></circle>
                <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
              </svg>
              <h3>Tidak Ada Transaksi</h3>
              <p>Belum ada transaksi yang perlu dikelola</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="admin-transactions-table">
            <div class="table-header">
              <div class="col-date">Tanggal</div>
              <div class="col-user">User ID</div>
              <div class="col-type">Tipe</div>
              <div class="col-exchange">Pertukaran</div>
              <div class="col-amount">Jumlah</div>
              <div class="col-total">Total</div>
              <div class="col-payment">Pembayaran</div>
              <div class="col-status">Status</div>
              <div class="col-actions">Aksi</div>
            </div>
            ${transactions
              .map(
                (transaction) => `
              <div class="table-row">
                <div class="col-date" data-label="Tanggal">
                  <div class="date-info">
                    <div class="date">${window.utils.formatDate(transaction.createdAt, { month: "short", day: "numeric" })}</div>
                    <div class="time">${new Date(transaction.createdAt).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" })}</div>
                  </div>
                </div>
                <div class="col-user" data-label="User">
                  <span class="user-id">${transaction.userId.slice(-8)}</span>
                </div>
                <div class="col-type" data-label="Tipe">
                  <span class="transaction-type ${transaction.type}">
                    ${transaction.type === "buy" ? "Beli" : "Jual"}
                  </span>
                </div>
                <div class="col-exchange" data-label="Pertukaran">
                  <div class="currency-exchange">
                    ${transaction.fromCurrency} → ${transaction.toCurrency}
                  </div>
                </div>
                <div class="col-amount" data-label="Jumlah">
                  ${window.utils.formatNumber(transaction.amount)} ${transaction.fromCurrency}
                </div>
                <div class="col-total" data-label="Total">
                  <strong>${window.utils.formatNumber(transaction.totalAmount)} ${transaction.toCurrency}</strong>
                </div>
                <div class="col-payment" data-label="Pembayaran">
                  <span class="payment-method">${transaction.paymentMethod.replace("_", " ").toUpperCase()}</span>
                </div>
                <div class="col-status" data-label="Status">
                  <span class="status-badge status-${transaction.status}">
                    ${getStatusText(transaction.status)}
                  </span>
                </div>
                <div class="col-actions" data-label="Aksi">
                  <div class="action-buttons">
                    <button class="btn btn-outline btn-sm" onclick="reviewTransaction('${transaction.id}')">
                      <svg style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                    ${
                      transaction.status === "pending"
                        ? `
                      <button class="btn btn-sm" style="background: #10b981; color: white;" onclick="updateTransactionStatus('${transaction.id}', 'completed')">
                        <svg style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                      </button>
                      <button class="btn btn-sm" style="background: #ef4444; color: white;" onclick="updateTransactionStatus('${transaction.id}', 'rejected')">
                        <svg style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
        `;
      }

      function loadUserData() {
        const users = window.utils.storage.get("dolarasia_users", []);
        const totalUsers = users.length;
        const adminUsers = users.filter((u) => u.isAdmin).length;
        const regularUsers = totalUsers - adminUsers;

        document.getElementById("total-users").textContent = totalUsers;
        document.getElementById("admin-users").textContent = adminUsers;
        document.getElementById("regular-users").textContent = regularUsers;

        // Display recent users
        const recentUsers = users
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 5);

        const userList = document.getElementById("user-list");
        userList.innerHTML = recentUsers
          .map(
            (user) => `
          <div class="user-item">
            <div class="user-info">
              <div class="user-name">${user.fullName}</div>
              <div class="user-email">${user.email}</div>
            </div>
            <div class="user-details">
              <span class="user-role ${user.isAdmin ? "admin" : "user"}">
                ${user.isAdmin ? "Admin" : "User"}
              </span>
              <span class="user-date">${window.utils.formatDate(user.createdAt)}</span>
            </div>
          </div>
        `,
          )
          .join("");
      }

      function initializeAdminFilters() {
        const statusFilter = document.getElementById("admin-status-filter");
        statusFilter.addEventListener("change", function () {
          const filterValue = this.value;
          const allTransactions = window.utils.storage.get(
            "dolarasia_transactions",
            [],
          );

          const filteredTransactions =
            filterValue === "all"
              ? allTransactions
              : allTransactions.filter((t) => t.status === filterValue);

          const sortedTransactions = filteredTransactions.sort(
            (a, b) => new Date(b.createdAt) - new Date(a.createdAt),
          );

          displayAdminTransactions(sortedTransactions);
        });

        const refreshBtn = document.getElementById("refresh-btn");
        refreshBtn.addEventListener("click", function () {
          loadAdminData();
          showNotification("Data berhasil di-refresh", "success");
        });
      }

      function getStatusText(status) {
        const statusMap = {
          pending: "Menunggu",
          completed: "Selesai",
          rejected: "Ditolak",
        };
        return statusMap[status] || status;
      }

      function reviewTransaction(transactionId) {
        const transactions = window.utils.storage.get(
          "dolarasia_transactions",
          [],
        );
        const transaction = transactions.find((t) => t.id === transactionId);

        if (!transaction) return;

        const users = window.utils.storage.get("dolarasia_users", []);
        const user = users.find((u) => u.id === transaction.userId);

        const modal = document.getElementById("review-modal");
        const content = document.getElementById("review-modal-content");

        content.innerHTML = `
          <div class="transaction-review">
            <div class="review-header">
              <h4>Transaksi #${transaction.id}</h4>
              <span class="status-badge status-${transaction.status}">
                ${getStatusText(transaction.status)}
              </span>
            </div>
            
            <div class="review-grid">
              <div class="review-section">
                <h5>Detail Transaksi</h5>
                <div class="detail-grid">
                  <div class="detail-item">
                    <label>Tanggal:</label>
                    <span>${window.utils.formatDateTime(transaction.createdAt)}</span>
                  </div>
                  <div class="detail-item">
                    <label>Tipe:</label>
                    <span>${transaction.type === "buy" ? "Beli" : "Jual"} ${transaction.toCurrency}</span>
                  </div>
                  <div class="detail-item">
                    <label>Pertukaran:</label>
                    <span>${transaction.fromCurrency} → ${transaction.toCurrency}</span>
                  </div>
                  <div class="detail-item">
                    <label>Jumlah:</label>
                    <span>${window.utils.formatNumber(transaction.amount)} ${transaction.fromCurrency}</span>
                  </div>
                  <div class="detail-item">
                    <label>Kurs:</label>
                    <span>${window.utils.formatNumber(transaction.exchangeRate)} IDR</span>
                  </div>
                  <div class="detail-item">
                    <label>Total:</label>
                    <span><strong>${window.utils.formatNumber(transaction.totalAmount)} ${transaction.toCurrency}</strong></span>
                  </div>
                  <div class="detail-item">
                    <label>Metode Pembayaran:</label>
                    <span>${transaction.paymentMethod.replace("_", " ").toUpperCase()}</span>
                  </div>
                </div>
              </div>
              
              <div class="review-section">
                <h5>Informasi User</h5>
                <div class="user-info">
                  ${
                    user
                      ? `
                    <div class="detail-item">
                      <label>Nama:</label>
                      <span>${user.fullName}</span>
                    </div>
                    <div class="detail-item">
                      <label>Email:</label>
                      <span>${user.email}</span>
                    </div>
                    <div class="detail-item">
                      <label>Telepon:</label>
                      <span>${user.phone}</span>
                    </div>
                    <div class="detail-item">
                      <label>Alamat:</label>
                      <span>${user.address}</span>
                    </div>
                  `
                      : `
                    <p>User tidak ditemukan (ID: ${transaction.userId})</p>
                  `
                  }
                </div>
              </div>
            </div>
            
            ${
              transaction.status === "pending"
                ? `
              <div class="review-actions">
                <button class="btn btn-success" onclick="updateTransactionStatus('${transaction.id}', 'completed')">
                  <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20,6 9,17 4,12"></polyline>
                  </svg>
                  Setujui Transaksi
                </button>
                <button class="btn btn-danger" onclick="updateTransactionStatus('${transaction.id}', 'rejected')">
                  <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                  Tolak Transaksi
                </button>
              </div>
            `
                : ""
            }
          </div>
        `;

        modal.classList.remove("hidden");
      }

      function updateTransactionStatus(transactionId, status) {
        const transactions = window.utils.storage.get(
          "dolarasia_transactions",
          [],
        );
        const transactionIndex = transactions.findIndex(
          (t) => t.id === transactionId,
        );

        if (transactionIndex !== -1) {
          transactions[transactionIndex].status = status;
          if (status === "completed" || status === "rejected") {
            transactions[transactionIndex].completedAt =
              new Date().toISOString();
          }

          window.utils.storage.set("dolarasia_transactions", transactions);

          // Close modal if open
          closeReviewModal();

          // Refresh display
          loadAdminData();

          const statusText = getStatusText(status);
          showNotification(
            `Transaksi berhasil ${statusText.toLowerCase()}`,
            "success",
          );
        }
      }

      function closeReviewModal() {
        const modal = document.getElementById("review-modal");
        modal.classList.add("hidden");
      }

      // Close modal when clicking outside
      document.addEventListener("click", function (e) {
        const modal = document.getElementById("review-modal");
        if (modal && e.target === modal) {
          closeReviewModal();
        }
      });
    </script>
  </body>
</html>
